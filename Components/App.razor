<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="_content/Blazor.Bootstrap/blazor.bootstrap.css" rel="stylesheet" />
    
    @* <link rel="stylesheet" href="bootstrap/bootstrap.min.css" /> *@
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="itasa_app.styles.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <HeadOutlet @rendermode="@InteractiveServer"/>
</head>

<body>
    <Routes  @rendermode="@InteractiveServer" />
    <script src="_framework/blazor.web.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <!-- Add chart.js reference if chart components are used in your application. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.0.1/chart.umd.js" integrity="sha512-gQhCDsnnnUfaRzD8k1L5llCCV6O9HN09zClIzzeJ8OJ9MpGmIlCxm+pdCkqTwqJ4JcjbojFr79rl2F1mzcoLMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Add chartjs-plugin-datalabels.min.js reference if chart components with data label feature is used in your application. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js" integrity="sha512-JPcRR8yFa8mmCsfrw4TNte1ZvF1e3+1SdGMslZvmrzDYxS69J7J49vkFL8u6u8PlPJK+H3voElBtUCzaXj+6ig==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Add sortable.js reference if SortableList component is used in your application. -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="_content/Blazor.Bootstrap/blazor.bootstrap.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    window.startScanner = (dotNetHelper) => {
        const html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        // ใช้กล้องหลัง (environment)
        html5QrCode.start({ facingMode: "environment" }, config,
            (decodedText, decodedResult) => {
                // เมื่อสแกนเจอ ส่งค่ากลับไปหา C#
                dotNetHelper.invokeMethodAsync('OnScanResult', decodedText);
                
                // สั่งปิดกล้องทันที
                html5QrCode.stop().then((ignore) => {
                    // Stopped
                }).catch((err) => {
                    // Stop failed
                });
            },
            (errorMessage) => {
                // parse error, ignore
            })
        .catch((err) => {
            console.log("Error starting scanner", err);
            alert("ไม่สามารถเปิดกล้องได้: " + err);
        });
    };

        window.setupSignaturePad = (canvasId) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            // ปรับความละเอียดให้คมชัดขึ้น (ป้องกันเส้นแตก)
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);

            const ctx = canvas.getContext('2d');
            ctx.lineWidth = 3; // เส้นหนาขึ้นนิดนึง
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000000';

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                let clientX = e.clientX;
                let clientY = e.clientY;

                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            function draw(e) {
                if (!isDrawing) return;
                if(e.type.startsWith('touch')) e.preventDefault(); // กันจอมือถือเลื่อน

                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                [lastX, lastY] = [pos.x, pos.y];
            }

            // Mouse Events
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const pos = getPos(e);
                [lastX, lastY] = [pos.x, pos.y];
            });
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false);

            // Touch Events
            canvas.addEventListener('touchstart', (e) => {
                isDrawing = true;
                const pos = getPos(e);
                [lastX, lastY] = [pos.x, pos.y];
            }, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', () => isDrawing = false);
        };

        // 2. ล้างกระดาน
        window.clearSignaturePad = (canvasId) => {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            // ต้อง clear ตามขนาดจริงที่คูณ ratio แล้ว
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        // 3. ดึงรูปภาพออกไปใช้
        window.getSignatureImage = (canvasId) => {
            const canvas = document.getElementById(canvasId);
            return canvas.toDataURL("image/png");
        };
</script>
</body>

</html>
