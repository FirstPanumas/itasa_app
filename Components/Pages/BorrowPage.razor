@page "/"
@using itasa_app.Models
@using Microsoft.AspNetCore.Components.Forms
@using BlazorBootstrap
@rendermode InteractiveServer

<h3>📦 ยืม-คืนอุปกรณ์ (Multi-Select)</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <Alert Color="AlertColor.Danger">
        <Icon Name="IconName.ExclamationTriangleFill" Class="me-2" /> @errorMessage
    </Alert>
}

@* --- ส่วนฟอร์มยืม (ปรับให้ Button Responsive นิดหน่อย) --- *@
<div class="card p-3 mb-4 shadow-sm">
    <EditForm Model="@newBorrow" OnValidSubmit="SaveBorrow">
        <DataAnnotationsValidator />

        <h5 class="text-primary mb-3"><Icon Name="IconName.PersonCircle" /> 1. ข้อมูลผู้ยืม</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">ชื่อผู้ยืม:</label>
                <InputText @bind-Value="newBorrow.BorrowerName" class="form-control" placeholder="ระบุชื่อผู้ยืม" />
                <ValidationMessage For="@(() => newBorrow.BorrowerName)" />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">แผนก:</label>
                <InputSelect @bind-Value="newBorrow.DepartmentCode" class="form-select">
                    <option value="">-- เลือกแผนก --</option>
                    @foreach (var d in departmentList)
                    {
                        <option value="@d.DepartmentCode">@d.DepartmentCode - @d.DepartmentName</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => newBorrow.DepartmentCode)" />
            </div>
            <div class="col-6 col-md-3 mb-3">
                <label class="form-label">วันที่ยืม:</label>
                <InputDate @bind-Value="newBorrow.BorrowDate" class="form-control" />
            </div>
            <div class="col-6 col-md-3 mb-3">
                <label class="form-label">กำหนดคืน:</label>
                <InputDate @bind-Value="newBorrow.DueDate" class="form-control" />
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">รูปภาพประกอบ:</label>
            <InputFile OnChange="LoadFiles" class="form-control" accept=".png,.jpg,.jpeg" />
            @if (!string.IsNullOrEmpty(previewImage))
            {
                <div class="mt-2">
                    <img src="@previewImage" width="150" class="img-thumbnail rounded" />
                </div>
            }
        </div>
        <hr />

        <div class="card bg-light mb-3 border-0">
            <div class="card-body">
                <h5 class="card-title text-primary"><Icon Name="IconName.CartPlus" /> 2. เลือกอุปกรณ์</h5>
                <div class="row align-items-end">
                    <div class="col-md-5 mb-2">
                        <label class="form-label">รายการอุปกรณ์ (ว่าง):</label>
                        <InputSelect Value="tempSelectedItemId"
                                     ValueChanged="@((int id) => OnItemSelected(id))"
                                     ValueExpression="@(() => tempSelectedItemId)"
                                     class="form-select">
                            <option value="0">-- เลือกอุปกรณ์ --</option>
                            @foreach (var item in itemList)
                            {
                                if (item.ItemStatus == ItemStatus.Ready && !cartList.Any(c => c.Id == item.Id))
                                {
                                    <option value="@item.Id">@item.ItemName (@item.ItemBarcode)</option>
                                }
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Barcode:</label>
                        <input type="text" class="form-control bg-white" value="@tempSelectedBarcode" readonly />
                    </div>
                    <div class="col-md-3 mb-2">
                        <Button Color="ButtonColor.Success" Class="w-100" @onclick="AddToCart">
                            <Icon Name="IconName.PlusLg" /> เพิ่มรายการ
                        </Button>
                    </div>
                </div>
            </div>
        </div>

        @if (cartList.Count > 0)
        {
            <div class="table-responsive mb-3">
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-secondary">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>ชื่ออุปกรณ์</th>
                            <th>Barcode</th>
                            <th class="text-center" style="width: 80px;">ลบ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < cartList.Count; i++)
                        {
                            var item = cartList[i];
                            <tr>
                                <td>@(i + 1)</td>
                                <td>@item.ItemName</td>
                                <td>@item.ItemBarcode</td>
                                <td class="text-center">
                                    <Button Color="ButtonColor.Danger" Size="ButtonSize.Small" @onclick="() => RemoveFromCart(item)">
                                        <Icon Name="IconName.XLg" />
                                    </Button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <Button Type="ButtonType.Submit" Color="ButtonColor.Primary" Size="ButtonSize.Large" Class="w-100 shadow">
                <Icon Name="IconName.Save" /> ยืนยันการยืม (@cartList.Count รายการ)
            </Button>
        }
        else
        {
            <Alert Color="AlertColor.Secondary" Class="text-center">ยังไม่มีรายการอุปกรณ์ที่เลือก</Alert>
        }
    </EditForm>
</div>

@* --- ส่วนประวัติการยืม (Responsive) --- *@
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mt-5 mb-3 gap-2">
    <h4><Icon Name="IconName.ClockHistory" /> ประวัติการยืมล่าสุด</h4>

    <div class="d-flex gap-2 flex-wrap">
        @* Dropdown Filter *@
        <select class="form-select" style="width: 150px;" value="@filterStatus" @onchange="OnStatusChanged">
            <option value="0">สถานะทั้งหมด</option>
            <option value="2">กำลังยืม</option>
            <option value="1">คืนแล้ว</option>
        </select>

        @* Search Text *@
        <div class="input-group" style="width: 250px;">
            <span class="input-group-text"><Icon Name="IconName.Search" /></span>
            <input type="text" class="form-control" placeholder="ค้นหา..." value="@searchText" @onchange="OnSearchTextChanged" />
        </div>

        <Button Color="ButtonColor.Primary" @onclick="SearchBorrow"><Icon Name="IconName.Search" /></Button>
        <Button Color="ButtonColor.Secondary" @onclick="ClearSearch"><Icon Name="IconName.ArrowCounterclockwise" /></Button>
    </div>
</div>

@* ========================================== *@
@* 💻 ส่วนที่ 1: Desktop View (แสดงเป็นตาราง) *@
@* ========================================== *@
<div class="d-none d-md-block">
    <Grid @ref="borrowGrid"
          TItem="BorrowModels"
          Class="table table-hover table-bordered table-striped align-middle"
          DataProvider="BorrowDataProvider"
          AllowFiltering="false"
          AllowPaging="true"
          AllowSorting="true"
          PageSize="10"
          Responsive="true">

        <GridColumns>
            <GridColumn TItem="BorrowModels" HeaderText="สถานะ" PropertyName="Status" TextAlignment="Alignment.Center">
                @if (context.Status == BorrowStatus.Borrowed) { <Badge Color="BadgeColor.Warning" TextColor="TextColor.Dark">กำลังยืม</Badge> }
                else { <Badge Color="BadgeColor.Success">คืนแล้ว</Badge> }
            </GridColumn>

            <GridColumn TItem="BorrowModels" HeaderText="จัดการ" TextAlignment="Alignment.Center" Sortable="false">
                @if (context.Status == BorrowStatus.Borrowed)
                {
                    <Button Color="ButtonColor.Primary" Size="ButtonSize.Small" Outline="true" @onclick="() => OpenReturnModal(context)">
                        <Icon Name="IconName.ArrowReturnLeft" /> คืนของ
                    </Button>
                }
                else { <span class="text-muted">-</span> }
            </GridColumn>

            <GridColumn TItem="BorrowModels" HeaderText="ผู้ยืม" PropertyName="BorrowerName" SortString="BorrowerName">@context.BorrowerName</GridColumn>
            <GridColumn TItem="BorrowModels" HeaderText="อุปกรณ์" PropertyName="Equipment" SortString="Equipment">@context.Equipment</GridColumn>
            <GridColumn TItem="BorrowModels" HeaderText="Barcode" PropertyName="Barcode" SortString="Barcode">@context.Barcode</GridColumn>
            <GridColumn TItem="BorrowModels" HeaderText="วันที่ยืม" PropertyName="BorrowDate" SortString="BorrowDate">@(context.BorrowDate.HasValue ? context.BorrowDate.Value.ToString("dd/MM/yy") : "-")</GridColumn>
            <GridColumn TItem="BorrowModels" HeaderText="กำหนดคืน" PropertyName="DueDate" SortString="DueDate">@(context.DueDate.HasValue ? context.DueDate.Value.ToString("dd/MM/yy") : "-")</GridColumn>
            <GridColumn TItem="BorrowModels" HeaderText="วันที่คืน" PropertyName="ReturnDate" SortString="ReturnDate">@(context.ReturnDate.HasValue ? context.ReturnDate.Value.ToString("dd/MM/yy") : "-")</GridColumn>
            
            <GridColumn TItem="BorrowModels" HeaderText="รูปภาพ" TextAlignment="Alignment.Center" Sortable="false">
                @if (!string.IsNullOrEmpty(context.PhotoPath))
                {
                    <a href="@context.PhotoPath" target="_blank"><img src="@context.PhotoPath" width="40" height="40" style="object-fit: cover; border-radius: 5px;" /></a>
                }
                else { <Icon Name="IconName.Image" Class="text-secondary" /> }
            </GridColumn>
        </GridColumns>
    </Grid>
</div>

@* ========================================== *@
@* 📱 ส่วนที่ 2: Mobile View (แสดงเป็นการ์ด)   *@
@* ========================================== *@
<div class="d-md-none">
    @* ต้องกรองข้อมูลเอง เพราะ Grid ไม่ทำงานในโหมดนี้ *@
    @foreach (var item in GetFilteredItemsForMobile())
    {
        <div class="card mb-3 shadow-sm border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h5 class="card-title text-primary mb-0 fw-bold">@item.Equipment</h5>
                        <small class="text-muted">@item.Barcode</small>
                    </div>
                    @if (item.Status == BorrowStatus.Borrowed) { <Badge Color="BadgeColor.Warning" TextColor="TextColor.Dark">กำลังยืม</Badge> }
                    else { <Badge Color="BadgeColor.Success">คืนแล้ว</Badge> }
                </div>

                <div class="card-text small mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">ผู้ยืม:</span> <span>@item.BorrowerName</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">วันที่ยืม:</span> <span>@(item.BorrowDate?.ToString("dd/MM/yy") ?? "-")</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold text-danger">กำหนดคืน:</span> <span class="text-danger">@(item.DueDate?.ToString("dd/MM/yy") ?? "-")</span>
                    </div>
                    @if (item.ReturnDate.HasValue)
                    {
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold text-success">วันที่คืน:</span>
                            <span class="text-success">@item.ReturnDate.Value.ToString("dd/MM/yy")</span>
                        </div>
                    }
                </div>

                @if (item.Status == BorrowStatus.Borrowed)
                {
                    <Button Color="ButtonColor.Primary" Class="w-100" Outline="true" @onclick="() => OpenReturnModal(item)">
                        <Icon Name="IconName.ArrowReturnLeft" /> คืนของ
                    </Button>
                }
            </div>
        </div>
    }
    
    @if (!GetFilteredItemsForMobile().Any())
    {
        <div class="text-center text-muted py-4">
            <Icon Name="IconName.Inbox" Class="fs-1 mb-2" />
            <p>ไม่พบข้อมูล</p>
        </div>
    }
</div>

@* --- Modal Return --- *@
<Modal @ref="returnModal" Title="จัดการการคืนอุปกรณ์" IsVerticallyCentered="true">
    <BodyTemplate>
        <EditForm Model="editingBorrow" OnValidSubmit="SaveReturn">
            <div class="mb-3">
                <label class="form-label fw-bold">ผู้ยืม:</label>
                <input type="text" class="form-control" value="@editingBorrow.BorrowerName" disabled />
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">อุปกรณ์ที่คืน:</label>
                <input type="text" class="form-control" value="@editingBorrow.Equipment" disabled />
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">สถานะ:</label>
                <InputSelect @bind-Value="editingBorrow.Status" class="form-select">
                    @foreach (var s in Enum.GetValues(typeof(BorrowStatus)))
                    {
                        <option value="@s">@s</option>
                    }
                </InputSelect>
            </div>
            @if (editingBorrow.Status == BorrowStatus.Return)
            {
                <div class="mb-3">
                    <label class="text-success fw-bold">วันที่คืนจริง:</label>
                    <InputDate @bind-Value="editingBorrow.ReturnDate" class="form-control" />
                </div>
            }
            <div class="text-end mt-4">
                <Button Color="ButtonColor.Secondary" @onclick="CloseReturnModal">ยกเลิก</Button>
                <Button Type="ButtonType.Submit" Color="ButtonColor.Primary">บันทึกการคืน</Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

@code {
    // ... (Code เดิมของคุณในไฟล์ .razor.cs ใช้ต่อได้เลย) ...

    // ✅ เพิ่มฟังก์ชันนี้ลงไปใน Block @code หรือไฟล์ .razor.cs เพื่อกรองข้อมูลให้ Mobile View
    private IEnumerable<BorrowModels> GetFilteredItemsForMobile()
    {
        var result = borrowList.AsEnumerable();

        if (filterStatus != 0)
            result = result.Where(x => (int)x.Status == filterStatus);

        if (!string.IsNullOrEmpty(searchText))
        {
            result = result.Where(x =>
                (x.BorrowerName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (x.Equipment?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (x.Barcode?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            );
        }
        
        // เรียงลำดับล่าสุดขึ้นก่อน
        return result.OrderByDescending(x => x.Id); 
    }
}