@page "/items"
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@using BlazorBootstrap
@using itasa_app.Models
@using Npgsql
@using System.IO
@using Microsoft.AspNetCore.Hosting

@inject IWebHostEnvironment WebHostEnvironment
@inject IJSRuntime JSRuntime

<h3>📦 จัดการรายการทรัพย์สิน (ItemPage)</h3>

@* --- ส่วนค้นหาและกรองข้อมูล --- *@
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mt-3 mb-3 gap-2">
    <div class="d-flex gap-2 flex-wrap">
        @* 1. กรองสถานะ *@
        <select class="form-select" style="width: 150px;" value="@filterStatus" @onchange="OnStatusChanged">
            <option value="0">สถานะทั้งหมด</option>
            @foreach (ItemStatus status in Enum.GetValues(typeof(ItemStatus)))
            {
                <option value="@((int)status)">@status</option>
            }
        </select>

        @* 2. ช่องค้นหา Text *@
        <div class="input-group" style="width: 100%; max-width: 300px;">
            <span class="input-group-text"><Icon Name="IconName.Search" /></span>
            <input type="text" class="form-control" placeholder="ชื่อ, บาร์โค้ด..."
                   @bind="searchText"
                   @bind:event="oninput"
                   @bind:after="SearchItem" />
            @* ปุ่มสแกน *@
            <button class="btn btn-info" type="button" @onclick="OpenScanModal" title="Scan Barcode">
                <Icon Name="IconName.QrCodeScan" />
            </button>
        </div>

        @* 3. ปุ่ม Reset *@
        <Button Color="ButtonColor.Secondary" @onclick="ClearSearch">
            <Icon Name="IconName.ArrowCounterclockwise" />
        </Button>

        @* 4. ปุ่มเพิ่มรายการ *@
        <Button Color="ButtonColor.Success" @onclick="ShowAddModal" Class="ms-auto ms-md-2">
            <Icon Name="IconName.PlusCircle" /> <span class="d-none d-md-inline">เพิ่มใหม่</span><span class="d-md-none">เพิ่ม</span>
        </Button>
    </div>
</div>

@* ========================================== *@
@* 💻 ส่วนที่ 1: Desktop View (แสดงเป็นตาราง) *@
@* ========================================== *@
<div class="d-none d-md-block">
    <Grid @ref="grid"
          TItem="ItemModels"
          Class="table table-hover table-bordered table-striped align-middle"
          DataProvider="ItemsDataProvider"
          AllowFiltering="false"
          AllowPaging="true"
          AllowSorting="true"
          PageSize="10"
          Responsive="true">

        <GridColumns>
            <GridColumn TItem="ItemModels" HeaderText="รูปภาพ" TextAlignment="Alignment.Center" Sortable="false">
                @if (!string.IsNullOrEmpty(context.ItemImage))
                {
                    <img src="@context.ItemImage" alt="img" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" />
                }
                else
                {
                    <Icon Name="IconName.Image" Class="text-secondary fs-3" />
                }
            </GridColumn>

            <GridColumn TItem="ItemModels" HeaderText="ชื่ออุปกรณ์" PropertyName="ItemName" SortString="ItemName">
                @context.ItemName
            </GridColumn>

            <GridColumn TItem="ItemModels" HeaderText="รายละเอียด" PropertyName="Description" SortString="Description">
                <span class="text-muted small">@context.Description</span>
            </GridColumn>

            <GridColumn TItem="ItemModels" HeaderText="บาร์โค้ด" PropertyName="ItemBarcode" SortString="ItemBarcode">
                <div class="d-flex align-items-center">
                    <Icon Name="IconName.UpcScan" Class="me-2 text-muted" /> @context.ItemBarcode
                </div>
            </GridColumn>

            <GridColumn TItem="ItemModels" HeaderText="สถานะ" PropertyName="ItemStatus" TextAlignment="Alignment.Center">
                @switch (context.ItemStatus)
                {
                    case ItemStatus.Ready:
                        <Badge Color="BadgeColor.Success">พร้อมใช้งาน</Badge>
                        break;
                    case ItemStatus.Borrowed:
                        <Badge Color="BadgeColor.Warning" TextColor="TextColor.Dark">กำลังยืม</Badge>
                        break;
                    default:
                        <Badge Color="BadgeColor.Secondary">@context.ItemStatus</Badge>
                        break;
                }
            </GridColumn>

            @* ✅ เพิ่ม Column ปุ่มแก้ไข *@
            <GridColumn TItem="ItemModels" HeaderText="จัดการ" TextAlignment="Alignment.Center" Sortable="false">
                <Button Color="ButtonColor.Warning" Size="ButtonSize.Small" @onclick="() => ShowEditModal(context)">
                    <Icon Name="IconName.PencilFill" class="text-white" /> แก้ไข
                </Button>
            </GridColumn>
        </GridColumns>
    </Grid>
</div>

@* ========================================== *@
@* 📱 ส่วนที่ 2: Mobile View (แสดงเป็นการ์ด)   *@
@* ========================================== *@
<div class="d-md-none">
    @foreach (var item in GetFilteredItemsForMobile())
    {
        <div class="card mb-3 shadow-sm border-0">
            <div class="card-body">
                <div class="d-flex gap-3">
                    @* รูปภาพด้านซ้าย *@
                    <div class="flex-shrink-0">
                        @if (!string.IsNullOrEmpty(item.ItemImage))
                        {
                            <img src="@item.ItemImage" class="rounded" style="width: 80px; height: 80px; object-fit: cover;" />
                        }
                        else
                        {
                            <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                <Icon Name="IconName.Image" Class="text-secondary fs-1" />
                            </div>
                        }
                    </div>

                    @* เนื้อหาด้านขวา *@
                    <div class="flex-grow-1 min-width-0">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <div class="card-title text-primary mb-0 text-truncate fw-bold fs-6">
                                @item.ItemName
                            </div>
                            @switch (item.ItemStatus)
                            {
                                case ItemStatus.Ready:
                                    <Badge Color="BadgeColor.Success">พร้อม</Badge>
                                    break;
                                case ItemStatus.Borrowed:
                                    <Badge Color="BadgeColor.Warning" TextColor="TextColor.Dark">ยืม</Badge>
                                    break;
                                default:
                                    <Badge Color="BadgeColor.Secondary">@item.ItemStatus</Badge>
                                    break;
                            }
                        </div>

                        <div class="text-muted small mb-2">
                            <Icon Name="IconName.UpcScan" /> @item.ItemBarcode
                        </div>

                        @if (!string.IsNullOrEmpty(item.Description))
                        {
                            <p class="card-text small text-muted text-truncate mb-0">
                                @item.Description
                            </p>
                        }
                    </div>
                </div>

                @* ✅ เพิ่มปุ่มแก้ไขใน Mobile *@
                <div class="mt-3 border-top pt-2 text-end">
                    <Button Color="ButtonColor.Warning" Size="ButtonSize.Small" Class="w-100 text-white" @onclick="() => ShowEditModal(item)">
                        <Icon Name="IconName.PencilFill" /> แก้ไขข้อมูล
                    </Button>
                </div>
            </div>
        </div>
    }

    @if (!GetFilteredItemsForMobile().Any())
    {
        <div class="text-center text-muted py-5">
            <Icon Name="IconName.Inbox" Class="fs-1 mb-2" />
            <p>ไม่พบรายการอุปกรณ์</p>
        </div>
    }
</div>

@* --- Modal สแกน Barcode --- *@
<Modal @ref="scanModal" Title="สแกน Barcode เพื่อค้นหา" IsVerticallyCentered="true">
    <BodyTemplate>
        <div class="text-center">
            <div id="reader" style="width: 100%; min-height: 300px; background-color: #f0f0f0;"></div>
            <p class="text-center mt-2 text-muted">กำลังเปิดกล้อง...</p>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Secondary" @onclick="CloseScanModal">ปิดกล้อง</Button>
    </FooterTemplate>
</Modal>

@* --- Modal เพิ่ม/แก้ไข ข้อมูล (Dynamic Title) --- *@
<Modal @ref="addModal" Title="@(newItem.Id == 0 ? "เพิ่มรายการอุปกรณ์ใหม่" : "แก้ไขรายการอุปกรณ์")">
    <BodyTemplate>
        <EditForm Model="@newItem" OnValidSubmit="SaveItem">
            <DataAnnotationsValidator />
            <div class="row g-3">
                <div class="col-md-12">
                    <label>ชื่ออุปกรณ์:</label>
                    <InputText @bind-Value="newItem.ItemName" class="form-control" />
                    <ValidationMessage For="@(() => newItem.ItemName)" />
                </div>
                <div class="col-md-6">
                    <label>บาร์โค้ด:</label>
                    <InputText @bind-Value="newItem.ItemBarcode" class="form-control" />
                    <ValidationMessage For="@(() => newItem.ItemBarcode)" />
                </div>
                <div class="col-md-6">
                    <label>สถานะ:</label>
                    <InputSelect @bind-Value="newItem.ItemStatus" class="form-select">
                        @foreach (var status in Enum.GetValues(typeof(ItemStatus)))
                        {
                            <option value="@status">@status</option>
                        }
                    </InputSelect>
                </div>
                <div class="col-md-12">
                    <label class="form-label">รูปภาพอุปกรณ์:</label>
                    <InputFile OnChange="HandleImageUpload" class="form-control" accept=".jpg,.jpeg,.png" />
                    @if (!string.IsNullOrEmpty(newItem.ItemImage))
                    {
                        <div class="mt-2 text-center">
                            <img src="@newItem.ItemImage" alt="Preview" class="img-thumbnail" style="max-height: 150px;" />
                        </div>
                    }
                </div>
                <div class="col-md-12">
                    <label>รายละเอียด:</label>
                    <InputTextArea @bind-Value="newItem.Description" class="form-control" rows="2" />
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-3 d-flex align-items-center" role="alert">
                    <Icon Name="IconName.ExclamationTriangleFill" Class="me-2" />
                    <div>@errorMessage</div>
                </div>
            }

            <div class="text-end mt-3">
                <Button Type="ButtonType.Submit" Color="ButtonColor.Success">บันทึก</Button>
                <Button Color="ButtonColor.Secondary" @onclick="HideAddModal">ยกเลิก</Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

@code {
    // Data
    private List<ItemModels> items = new List<ItemModels>();
    private ItemModels newItem = new ItemModels();

    // UI Controls
    private Grid<ItemModels> grid = default!;
    private Modal addModal = default!;
    private Modal scanModal = default!;
    private string errorMessage = "";

    // Search & Filter Params
    private string searchText = "";
    private int filterStatus = 0; // 0 = ทั้งหมด

    // Scanner
    private bool isScanning = false;
    private DotNetObjectReference<ItemPage>? objRef;

    // Config
    private long maxFileSize = 1024 * 1024 * 5;

    protected override void OnInitialized()
    {
        FetchData();
    }

    // --- 1. Grid Data Provider (สำหรับ Desktop) ---
    private async Task<GridDataProviderResult<ItemModels>> ItemsDataProvider(GridDataProviderRequest<ItemModels> request)
    {
        if (items is null || items.Count == 0) FetchData();

        var result = items.AsEnumerable();

        // กรองตาม Search Text
        if (!string.IsNullOrEmpty(searchText))
        {
            result = result.Where(x =>
                (x.ItemName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (x.ItemBarcode?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (x.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            );
        }

        // กรองตามสถานะ
        if (filterStatus != 0)
        {
            result = result.Where(x => (int)x.ItemStatus == filterStatus);
        }

        return await Task.FromResult(request.ApplyTo(result));
    }

    // --- 2. Mobile Filter Helper (สำหรับ Mobile Card Loop) ---
    private IEnumerable<ItemModels> GetFilteredItemsForMobile()
    {
        if (items is null) return Enumerable.Empty<ItemModels>();

        var result = items.AsEnumerable();

        if (filterStatus != 0)
            result = result.Where(x => (int)x.ItemStatus == filterStatus);

        if (!string.IsNullOrEmpty(searchText))
        {
            result = result.Where(x =>
                (x.ItemName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (x.ItemBarcode?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (x.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            );
        }

        // เรียงลำดับล่าสุดขึ้นก่อน
        return result.OrderByDescending(x => x.Id);
    }

    // --- UI Actions ---
    private async Task SearchItem()
    {
        await grid.RefreshDataAsync();
    }

    private async Task OnStatusChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int result))
        {
            filterStatus = result;
        }
        await grid.RefreshDataAsync();
    }

    private async Task ClearSearch()
    {
        searchText = "";
        filterStatus = 0;
        await grid.RefreshDataAsync();
    }

    private async Task ShowAddModal()
    {
        newItem = new ItemModels();
        errorMessage = "";
        await addModal.ShowAsync();
    }

    // ✅ เพิ่ม Method สำหรับเปิด Modal แก้ไข
    private async Task ShowEditModal(ItemModels item)
    {
        // Clone ข้อมูล เพื่อไม่ให้กระทบ List หลักขณะพิมพ์
        newItem = new ItemModels
        {
            Id = item.Id,
            ItemName = item.ItemName,
            ItemBarcode = item.ItemBarcode,
            Description = item.Description,
            ItemStatus = item.ItemStatus,
            ItemImage = item.ItemImage
        };

        errorMessage = "";
        await addModal.ShowAsync();
    }

    private async Task HideAddModal() => await addModal.HideAsync();

    // --- Scanner Logic ---
    private async Task OpenScanModal()
    {
        await scanModal.ShowAsync();
        await Task.Delay(300);
        objRef = DotNetObjectReference.Create(this);
        await JSRuntime.InvokeVoidAsync("startScanner", objRef);
    }

    private async Task CloseScanModal()
    {
        await JSRuntime.InvokeVoidAsync("stopScanner");
        await scanModal.HideAsync();
        objRef?.Dispose();
    }

    [JSInvokable]
    public async Task OnScanResult(string barcode)
    {
        searchText = barcode;
        await CloseScanModal();
        await SearchItem();
        StateHasChanged();
    }

    // --- Database Fetch ---
    private void FetchData()
    {
        try
        {
            items.Clear();
            using (NpgsqlConnection conn = new Myconnection().GetConnection())
            {
                using (NpgsqlCommand cmd = conn.CreateCommand())
                {
                    cmd.CommandText = @"
                    SELECT ""Id"", ""ItemName"", ""Description"", ""ItemBarcode"", ""ItemStatus"", ""ItemImage""
                    FROM public.item_tb
                    ORDER BY ""Id"" DESC";

                    if (conn.State != System.Data.ConnectionState.Open) conn.Open();

                    using (NpgsqlDataReader reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            items.Add(new ItemModels()
                            {
                                Id = Convert.ToInt32(reader["Id"]),
                                ItemName = reader["ItemName"].ToString(),
                                Description = reader["Description"] != DBNull.Value ? reader["Description"].ToString() : "",
                                ItemBarcode = reader["ItemBarcode"] != DBNull.Value ? reader["ItemBarcode"].ToString() : "",
                                ItemStatus = (ItemStatus)Convert.ToInt32(reader["ItemStatus"]),
                                ItemImage = reader["ItemImage"] != DBNull.Value ? reader["ItemImage"].ToString() : ""
                            });
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    // --- Upload Logic ---
    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            try
            {
                var fileExtension = Path.GetExtension(file.Name);
                var newFileName = $"{Guid.NewGuid()}{fileExtension}";
                var uploadFolder = Path.Combine(WebHostEnvironment.WebRootPath, "uploads");

                if (!Directory.Exists(uploadFolder)) Directory.CreateDirectory(uploadFolder);

                var filePath = Path.Combine(uploadFolder, newFileName);
                await using (var fs = new FileStream(filePath, FileMode.Create))
                {
                    await file.OpenReadStream(maxFileSize).CopyToAsync(fs);
                }

                newItem.ItemImage = $"/uploads/{newFileName}";
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Upload Failed: {ex.Message}");
            }
        }
    }

    // --- ✅ Database Save (Insert & Update Logic) ---
    private async Task SaveItem()
    {
        errorMessage = "";
        try
        {
            using (NpgsqlConnection conn = new Myconnection().GetConnection())
            {
                if (conn.State != System.Data.ConnectionState.Open) conn.Open();

                // 1. ตรวจสอบ Barcode ซ้ำ (Duplicate Check)
                using (NpgsqlCommand checkCmd = conn.CreateCommand())
                {
                    // เช็คว่ามี Barcode นี้หรือไม่ (ต้องไม่ใช่ ID ตัวเอง กรณีแก้ไข)
                    checkCmd.CommandText = @"SELECT COUNT(*) FROM public.item_tb
                                             WHERE ""ItemBarcode"" = @barcode
                                             AND ""Id"" != @id";

                    checkCmd.Parameters.AddWithValue("barcode", newItem.ItemBarcode ?? "");
                    checkCmd.Parameters.AddWithValue("id", newItem.Id); // ถ้าเพิ่มใหม่ Id=0

                    long count = Convert.ToInt64(checkCmd.ExecuteScalar());

                    if (count > 0)
                    {
                        errorMessage = $"บาร์โค้ด '{newItem.ItemBarcode}' มีอยู่ในระบบแล้ว!";
                        return;
                    }
                }

                // 2. ดำเนินการ Save (Insert หรือ Update)
                using (NpgsqlCommand cmd = conn.CreateCommand())
                {
                    if (newItem.Id == 0)
                    {
                        // --- CASE INSERT (เพิ่มใหม่) ---
                        cmd.CommandText = @"
                            INSERT INTO public.item_tb (""ItemName"", ""Description"", ""ItemBarcode"", ""ItemStatus"", ""ItemImage"")
                            VALUES (@name, @desc, @barcode, @status, @image)";
                    }
                    else
                    {
                        // --- CASE UPDATE (แก้ไข) ---
                        cmd.CommandText = @"
                            UPDATE public.item_tb
                            SET ""ItemName"" = @name,
                                ""Description"" = @desc,
                                ""ItemBarcode"" = @barcode,
                                ""ItemStatus"" = @status,
                                ""ItemImage"" = @image
                            WHERE ""Id"" = @id";

                        cmd.Parameters.AddWithValue("id", newItem.Id);
                    }

                    // Parameters ที่ใช้ร่วมกัน
                    cmd.Parameters.AddWithValue("name", newItem.ItemName);
                    cmd.Parameters.AddWithValue("desc", newItem.Description ?? "");
                    cmd.Parameters.AddWithValue("barcode", newItem.ItemBarcode ?? "");
                    cmd.Parameters.AddWithValue("status", (int)newItem.ItemStatus);
                    cmd.Parameters.AddWithValue("image", newItem.ItemImage ?? "");

                    await cmd.ExecuteNonQueryAsync();
                }
            }

            await HideAddModal();
            newItem = new ItemModels(); // Reset Form
            errorMessage = "";

            FetchData(); // โหลดข้อมูลใหม่
            await grid.RefreshDataAsync(); // Refresh ตาราง
        }
        catch (Exception ex)
        {
            errorMessage = $"เกิดข้อผิดพลาด: {ex.Message}";
        }
    }
}