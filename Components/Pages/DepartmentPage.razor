@page "/departments"
@rendermode InteractiveServer
@using BlazorBootstrap
@using itasa_app.Models
@using Npgsql
@using System.Data

<h3>🏢 จัดการแผนก (Department)</h3>
<div class="d-flex justify-content-between align-items-center mt-3 mb-3">
    <div class="d-flex gap-2">
        <Button Color="ButtonColor.Primary" @onclick="ShowAddModal">
            <Icon Name="IconName.PlusCircle" /> เพิ่มแผนกใหม่
        </Button>
    </div>
</div>

@* --- ตารางแสดงข้อมูล (Grid) --- *@
<Grid @ref="grid"
      TItem="DepartmentModels"
      Class="table table-hover table-bordered table-striped align-middle"
      DataProvider="DepartmentsDataProvider"
      AllowFiltering="true"
      AllowPaging="true"
      PageSize="10"
      Responsive="true">

    <GridColumns>
        <GridColumn TItem="DepartmentModels" HeaderText="รหัสแผนก" PropertyName="DepartmentCode" SortString="DepartmentCode">
            @context.DepartmentCode
        </GridColumn>

        <GridColumn TItem="DepartmentModels" HeaderText="ชื่อแผนก" PropertyName="DepartmentName" SortString="DepartmentName">
            @context.DepartmentName
        </GridColumn>

        @* ✅ 1. เพิ่ม Column ปุ่มแก้ไข *@
        <GridColumn TItem="DepartmentModels" HeaderText="จัดการ" TextAlignment="Alignment.Center" Sortable="false">
            <Button Color="ButtonColor.Warning" Size="ButtonSize.Small" @onclick="() => ShowEditModal(context)">
                <Icon Name="IconName.PencilFill" class="text-white" /> แก้ไข
            </Button>
        </GridColumn>
    </GridColumns>
</Grid>

@* --- Modal สำหรับเพิ่ม/แก้ไขข้อมูล --- *@
@* ✅ ปรับ Title ให้เปลี่ยนตามสถานะ *@
<Modal @ref="addModal" Title="@(newDept.Id == 0 ? "เพิ่มแผนกใหม่" : "แก้ไขข้อมูลแผนก")">
    <BodyTemplate>
        <EditForm Model="@newDept" OnValidSubmit="SaveDepartment">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label class="form-label">รหัสแผนก (Code):</label>
                <InputText @bind-Value="newDept.DepartmentCode" class="form-control" placeholder="เช่น IT, HR, AC" />
                <ValidationMessage For="@(() => newDept.DepartmentCode)" />
            </div>

            <div class="mb-3">
                <label class="form-label">ชื่อแผนก:</label>
                <InputText @bind-Value="newDept.DepartmentName" class="form-control" placeholder="ระบุชื่อแผนก" />
                <ValidationMessage For="@(() => newDept.DepartmentName)" />
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <Alert Color="AlertColor.Danger">
                    <Icon Name="IconName.ExclamationTriangleFill" class="me-2" /> @errorMessage
                </Alert>
            }

            <div class="d-flex justify-content-end gap-2 mt-3">
                <Button Color="ButtonColor.Secondary" @onclick="HideAddModal">ยกเลิก</Button>
                <Button Type="ButtonType.Submit" Color="ButtonColor.Success">
                    <Icon Name="IconName.Floppy" class="me-1" /> บันทึก
                </Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

@code {
    // --- ตัวแปร ---
    private List<DepartmentModels> departments = new List<DepartmentModels>();
    private DepartmentModels newDept = new DepartmentModels();
    private string errorMessage = "";

    // ตัวแปร UI
    private Grid<DepartmentModels> grid = default!;
    private Modal addModal = default!;

    protected override void OnInitialized()
    {
        FetchData();
    }

    // --- Grid Data Provider ---
    private async Task<GridDataProviderResult<DepartmentModels>> DepartmentsDataProvider(GridDataProviderRequest<DepartmentModels> request)
    {
        if (departments is null || departments.Count == 0) FetchData();
        return await Task.FromResult(request.ApplyTo(departments));
    }

    // --- Modal Logic ---
    private async Task ShowAddModal()
    {
        newDept = new DepartmentModels(); // ล้างค่าเป็น Id=0
        errorMessage = "";
        await addModal.ShowAsync();
    }

    // ✅ 2. เพิ่มฟังก์ชัน ShowEditModal
    private async Task ShowEditModal(DepartmentModels item)
    {
        // Clone ข้อมูลเพื่อไม่ให้กระทบ Grid ทันทีที่พิมพ์
        newDept = new DepartmentModels
        {
            Id = item.Id,
            DepartmentCode = item.DepartmentCode,
            DepartmentName = item.DepartmentName
        };
        errorMessage = "";
        await addModal.ShowAsync();
    }

    private async Task HideAddModal()
    {
        await addModal.HideAsync();
    }

    // --- Database Logic (Read) ---
    private void FetchData()
    {
        try
        {
            departments.Clear();
            using (NpgsqlConnection conn = new Myconnection().GetConnection())
            {
                if (conn.State != ConnectionState.Open) conn.Open(); // Ensure Open

                using (NpgsqlCommand cmd = conn.CreateCommand())
                {
                    cmd.CommandText = @"
                        SELECT ""Id"", ""DepartmentCode"", ""DepartmentName""
                        FROM public.department_tb
                        ORDER BY ""Id"" ASC";

                    using (NpgsqlDataReader reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            departments.Add(new DepartmentModels
                            {
                                Id = Convert.ToInt32(reader["Id"]),
                                DepartmentCode = reader["DepartmentCode"].ToString(),
                                DepartmentName = reader["DepartmentName"].ToString()
                            });
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error Fetching Departments: {ex.Message}");
        }
    }

    // --- Database Logic (Create & Update) ---
    private async Task SaveDepartment()
    {
        try
        {
            using (NpgsqlConnection conn = new Myconnection().GetConnection())
            {
                if (conn.State != ConnectionState.Open) conn.Open();

                // ✅ 3. เช็ค Code ซ้ำ (ต้องไม่นับตัวเอง กรณีแก้ไข)
                using (NpgsqlCommand checkCmd = conn.CreateCommand())
                {
                    // เช็คว่ามี Code นี้หรือไม่ โดย ID ต้องไม่เท่ากับตัวปัจจุบัน
                    checkCmd.CommandText = @"SELECT COUNT(*) FROM public.department_tb
                                             WHERE ""DepartmentCode"" = @code
                                             AND ""Id"" != @id";

                    checkCmd.Parameters.AddWithValue("code", newDept.DepartmentCode);
                    checkCmd.Parameters.AddWithValue("id", newDept.Id); // ถ้าเพิ่มใหม่ Id จะเป็น 0

                    long count = Convert.ToInt64(checkCmd.ExecuteScalar());

                    if (count > 0)
                    {
                        errorMessage = $"รหัสแผนก '{newDept.DepartmentCode}' มีอยู่แล้วในระบบ!";
                        return;
                    }
                }

                // ✅ 4. แยก Logic Insert / Update
                using (NpgsqlCommand cmd = conn.CreateCommand())
                {
                    if (newDept.Id == 0)
                    {
                        // --- Insert ---
                        cmd.CommandText = @"
                            INSERT INTO public.department_tb (""DepartmentCode"", ""DepartmentName"")
                            VALUES (@code, @name)";
                    }
                    else
                    {
                        // --- Update ---
                        cmd.CommandText = @"
                            UPDATE public.department_tb
                            SET ""DepartmentCode"" = @code,
                                ""DepartmentName"" = @name
                            WHERE ""Id"" = @id";

                        cmd.Parameters.AddWithValue("id", newDept.Id);
                    }

                    cmd.Parameters.AddWithValue("code", newDept.DepartmentCode);
                    cmd.Parameters.AddWithValue("name", newDept.DepartmentName);

                    cmd.ExecuteNonQuery();
                }
            }

            // Success
            await HideAddModal();
            FetchData(); // โหลดข้อมูลใหม่
            await grid.RefreshDataAsync(); // รีเฟรชตาราง
        }
        catch (Exception ex)
        {
            errorMessage = $"บันทึกไม่สำเร็จ: {ex.Message}";
        }
    }
}